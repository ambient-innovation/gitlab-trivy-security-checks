name: Release
on:
  push:
    branches: [main]

jobs:
  release_new_version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Find version number and release via semantic-release
        uses: codfish/semantic-release-action@v3
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          additional-packages: |
            ["semantic-release-replace-plugin", "@semantic-release/git"]
          plugins: |
            [
              ["@semantic-release/commit-analyzer",
                {
                  "preset": "angular",
                  "releaseRules":
                  [
                    {
                      "type": "docs",
                      "scope": "README",
                      "release": "patch"
                    },
                    {
                      "type": "chore",
                      "release": "patch"
                    },
                    {
                      "type": "chore",
                      "scope": "release",
                      "release": false
                    },
                    {
                      "type": "refactor",
                      "release": "patch"
                    },
                    {
                      "scope": "bugfix",
                      "release": "minor"
                    }
                  ]
                }
              ],
              "@semantic-release/release-notes-generator",
              ["semantic-release-replace-plugin",
                {
                  "replacements":
                  [
                    {
                      "files":
                      [
                        "security-checks.yaml"
                      ],
                      "from": "gitlab-trivy-security-checks\\/v(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?\\/security-checks\\.template\\.yaml",
                      "to": "gitlab-trivy-security-checks/v${nextRelease.version}/security-checks.template.yaml"
                    }
                  ]
                }
              ],
              ["@semantic-release/git",
                {
                  "assets":
                  [
                    "security-checks.yaml"
                  ]
                }
              ],
              "@semantic-release/github"
            ]
    outputs:
      version: ${{ steps.semantic.outputs.release-version }}
      new-release: ${{ steps.semantic.outputs.new-release-published }}

  dispatch_main_repo:
    runs-on: ubuntu-latest
    needs: release_new_version
    if: ${{ needs.release_new_version.outputs.version }}
    steps:
      - name: Dispatch hook in main repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.access_token }}
          repository: ambient-innovation/gitlab-trivy-checks
          event-type: update-security-checks
          client-payload: '{"version": "${{ needs.release_new_version.outputs.version }}"}'